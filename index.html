<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShimeChamhoc ‚Äì Full Features</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script>
let searchKeywordN = ''; // ‚úÖ keyword ƒë√£ strip s·∫µn
    let currentQuizIndex = 0;
let searchKeyword = '';
    let isSubmitted = false;
let qCells = [];      // l∆∞u DOM c·ªßa t·ª´ng √¥ theo index
let mapBuilt = false; // ƒë√£ build map ch∆∞a
let currentCellIndex = -1;
window.MathJax = {
  tex: { inlineMath: [['\\(','\\)'], ['$', '$']] }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root { 
      --bg: #0b1220; --card: rgba(22, 32, 53, 0.8); --muted: #94a3b8; 
      --text: #f8fafc; --acc: #38bdf8; --ok: #22c55e; --bad: #ef4444; 
      --border: rgba(255, 255, 255, 0.08);
    }
    /* ===== LIGHT MODE ===== */
[data-theme="light"] {
  --bg: #f1f5f9;
  --card: rgba(255, 255, 255, 0.9);
  --muted: #475569;
  --text: #0f172a;
  --acc: #0284c7;
  --ok: #16a34a;
  --bad: #dc2626;
  --border: rgba(0, 0, 0, 0.08);
}
/* ===== FIX dropdown khi Light mode ===== */
[data-theme="light"] select,
[data-theme="light"] option {
  background: #ffffff;
  color: #0f172a;
  border-color: rgba(0, 0, 0, 0.15);
}

    * { box-sizing: border-box; transition: all 0.2s ease; }
    body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: radial-gradient(circle at top right, var(--bg), #0b1220);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(11, 18, 32, 0.7); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1100px; margin: auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }
    .pad { padding: 24px; }
    .muted { color: var(--muted); font-size: 14px; }
    .btn {
      cursor: pointer; border: none; border-radius: 12px; padding: 12px 18px;
      font-weight: 600; background: #1b2a4a; color: #dbe7ff;
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); background: #2a3d66; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn.secondary { background: #334155; color: #f1f5f9; }
    .btn.ok { background: #14532d; color: #bbf7d0; }
    .btn.warn { background: #7f1d1d; color: #fecaca; }
    .grid { display: grid; gap: 12px; }
   select#quizSelect {
  appearance: none;
  background-image:
    linear-gradient(45deg, transparent 50%, var(--muted) 50%),
    linear-gradient(135deg, var(--muted) 50%, transparent 50%);
  background-position:
    calc(100% - 18px) 55%,
    calc(100% - 12px) 55%;
  background-size: 6px 6px;
  background-repeat: no-repeat;
}
    .choice {
      border: 1px solid var(--border); border-radius: 14px; padding: 16px;
      cursor: pointer; background: rgba(255,255,255,0.03); display: flex; align-items: center;
    }
    .choice:hover { border-color: var(--acc); transform: translateX(4px); }
    .choice.active { outline: 2px solid var(--acc); background: rgba(56, 189, 248, 0.1); }
    .choice.correct { outline: 2px solid var(--ok); background: rgba(34, 197, 94, 0.15); }
    .choice.wrong { outline: 2px solid var(--bad); background: rgba(239, 68, 68, 0.15); }
    .pill { display: inline-block; padding: 4px 12px; border-radius: 8px; background: rgba(56, 189, 248, 0.1); color: var(--acc); font-size: 12px; font-weight: 600; }
    .timer { font-family: monospace; font-size: 18px; color: #fbbf24; }
    .progress { height: 10px; background: #111a2d; border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; background: linear-gradient(90deg, var(--acc), #4ade80); transition: width 0.4s ease; }
    #sheepPopup {
      position: fixed; inset: 0; display: none; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 9999;
    }
    #sheepPopup .box{
      max-width: 240px;
  width: fit-content;
  pointer-events: auto;
  background: transparent;  
  border: none;
  box-shadow: none;
  padding: 10px 14px 6px;
  text-align: center;
  animation: stickerPop .35s cubic-bezier(.2,1.4,.4,1);
}



#sheepPopup img{
  width:150px;
  height:auto;
  display:block;
  margin:0 auto 6px;

  /* VI·ªÄN STICKER */
  filter:
    drop-shadow(0 0 0 6px white)
    drop-shadow(0 10px 22px rgba(0,0,0,0.35));

  transform: rotate(-4deg);
}


    #qText{
  max-height: 260px;
  overflow-y: auto;
  padding-right: 6px;
  word-break: break-word;
  line-height: 1.6;
}

@media (max-width: 960px) { 
  .row { grid-template-columns: 1fr; } 
}
@keyframes pop{
  0%   { transform: scale(0.7) rotate(-8deg); opacity: 0 }
  60%  { transform: scale(1.05) rotate(3deg); opacity: 1 }
  100% { transform: scale(1) rotate(0deg); }
}
@keyframes stickerPop{
  0% {
    transform: scale(0.3) rotate(-12deg);
    opacity: 0;
  }
  70% {
    transform: scale(1.08) rotate(3deg);
    opacity: 1;
  }
  100% {
    transform: scale(1) rotate(0deg);
  }
}
[data-theme="light"] select#quizSelect {
  background: #ffffff !important;
  color: #0f172a !important;
}
#fireworks {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9998;
}

#congratsText {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  font-size: 2.2rem;
  font-weight: 800;
  color: var(--ok);
  opacity: 0;
  z-index: 9999;
  text-align: center;
  transition: all 0.4s ease;
}

#congratsText.show {
  opacity: 1;
  transform: translateX(-50%) scale(1);
}
#resultOverlay {
  position: fixed;
  inset: 0;
  background: rgba(11, 18, 32, 0.65);
  backdrop-filter: blur(6px);
  z-index: 9997;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease;
}

#resultOverlay.show {
  opacity: 1;
  pointer-events: auto;
}
.qcell {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  border: 2px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: 600;
  position: relative;
}

.qcell.done { border-color: var(--acc); }
.qcell.correct { background: rgba(34,197,94,0.2); border-color: var(--ok); }
.qcell.wrong { background: rgba(239,68,68,0.2); border-color: var(--bad); }

.qcell.bookmark::after {
  content: "‚≠ê";
  position: absolute;
  font-size: 12px;
  top: -6px;
  right: -4px;
}

.bookmark-btn {
  cursor: pointer;
  font-size: 22px;
  user-select: none;
  transition: transform .2s ease, color .2s ease;
}
.bookmark-btn:hover {
  transform: scale(1.2);
}
.bookmark-btn.active {
  color: #facc15; /* v√†ng */
}


  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:800;font-size:1.2rem; color: var(--acc)">üìò ShimeChamhoc</div>
      <button class="btn secondary" onclick="$('#fileInput').click()">N·∫°p JSON</button>
      <button class="btn ghost" id="toggleTheme">üåô / ‚òÄÔ∏è</button>

    </div>
  </header>

  <main class="wrap" style="margin-top:24px">
    <div class="row">
      <aside class="card pad">
        <h3>C√†i ƒë·∫∑t</h3>
        <div class="grid">
          <div class="grid muted" id="quizSelectGroup" style="display:none">
            <label>Ch·ªçn b·ªô ƒë·ªÅ</label>
            <select id="quizSelect"></select>
          </div>
          <div class="grid muted">
            <label>Th·ªùi gian (ph√∫t)</label>
            <input type="number" id="timeLimit" min="0" value="0" style="padding:10px; border-radius:8px; background:#0d1424; color:white; border:1px solid var(--border)"/>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="shuffle" checked /> <label for="shuffle">X√°o tr·ªôn ƒë·ªÅ</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="instant" checked /> <label for="instant">Ch·∫•m t·ª©c th√¨</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="autoNext" /> <label for="autoNext">T·ª± chuy·ªÉn c√¢u</label>
          </div>
          <button class="btn ok" id="btnStart" style="width:100%; margin-top:10px">B·∫Øt ƒë·∫ßu</button>
        </div>
      </aside>

      <section class="card pad" id="panelMain">
        <div id="screenIntro">
          <h2 style="margin-top:0">S·∫µn s√†ng ch∆∞a?</h2>
          <p class="muted" id="statusMessage">ƒêang ch·ªù d·ªØ li·ªáu...</p>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>

        <div id="screenQuiz" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <span class="pill" id="qIndex"></span>

            <div style="display:flex;align-items:center;gap:14px">
                <span id="bookmarkBtn" class="bookmark-btn">‚≠ê</span>
                <div class="timer pill" id="timer">--:--</div>
          </div>
          </div>

          <div id="qText" style="font-size:20px;font-weight:700;margin-bottom:24px;"></div>
          <div id="qChoices" class="grid"></div>
          <div style="display:flex;justify-content:space-between;margin-top:30px; border-top: 1px solid var(--border); padding-top:20px">
            <button class="btn secondary" id="btnPrev">‚Üê Tr∆∞·ªõc</button>
            <div style="display:flex; gap:10px">
              <button class="btn ok" id="btnNext">Ti·∫øp ‚Üí</button>
              <button class="btn warn" id="btnSubmit">N·ªôp b√†i</button>
            </div>
          </div>
          <div id="explain" class="muted" style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px"></div>
          <button class="btn secondary" id="btnAIExplain" style="margin-top:10px">
  ü§ñ Gi·∫£i th√≠ch b·∫±ng AI
          </button>
          <div id="questionMap" class="card pad" style="margin-top:20px">

          <div style="font-weight:700;margin-bottom:10px">üìã T·ªïng quan c√¢u h·ªèi</div>

  <!-- FILTER BUTTONS -->
          <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn secondary" id="filterAll">T·∫•t c·∫£</button>
          <button class="btn secondary" id="filterBookmark">‚≠ê Bookmark</button>
          <button class="btn secondary" id="filterWrong">‚ùå C√¢u sai</button>
          </div>
          <input id="searchBox" placeholder="T√¨m c√¢u h·ªèi..." 
            style="width:100%; padding:10px; border-radius:10px;
            background:rgba(255,255,255,0.03); color:var(--text);
            border:1px solid var(--border); margin-bottom:10px;">

           <div id="questionGrid"
       style="display:grid;grid-template-columns:repeat(auto-fill,40px);gap:8px">
  </div>
</div>

        </div>

        <div id="screenResult" style="display:none">
          <h2 style="color: var(--ok)">Ho√†n th√†nh!</h2>
          <p id="scoreLine" style="font-size: 1.5rem; font-weight: 800;"></p>
          <div class="progress" style="margin:20px 0"><div id="scoreBar"></div></div>
          <div style="display:flex; gap:10px; margin-bottom:20px">
            <button class="btn ok" onclick="location.reload()">L√†m ƒë·ªÅ kh√°c</button>
          </div>
          <div id="reviewArea"></div>
        </div>
      </section>
    </div>
  </main>

  <div id="sheepPopup">
    <div class="box">
      <img src="sheep.png" alt="Sheep sticker">
      <div style="font-weight:800">C·ªë g·∫Øng l√™nnn! üêë</div>
      <p class="muted">Sai 3 c√¢u r·ªìi ƒë√≥, b√¨nh tƒ©nh nh√©!</p>
      <button class="btn ok" onclick="$('#sheepPopup').style.display='none'; wrongStreak=0;">Ti·∫øp t·ª•c</button>
    </div>
  </div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const strip = (s)=> (s??'').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
    // ===== SEARCH INDEX (pre-strip 1 l·∫ßn khi n·∫°p JSON) =====
let searchIndex = []; 
// searchIndex[qz] = { titleN: "...", q: [ { textN:"", choicesN:[...], expN:"" } ] }

function buildSearchIndex(quizzes) {
  searchIndex = quizzes.map(qz => ({
    titleN: strip(qz.title || ''),
    q: (qz.questions || []).map(qq => ({
      textN: strip(qq.text || ''),
      choicesN: (qq.choices || []).map(c => strip(c || '')),
      expN: strip(qq.explanation || '')
    }))
  }));
}
function questionMatches(qzIndex, i) {
  const k = searchKeywordN; // ‚úÖ ƒë√£ strip s·∫µn
  if (!k) return true;

  const qi = searchIndex[qzIndex]?.q?.[i];
  if (!qi) return true;

  return (
    qi.textN.includes(k) ||
    qi.expN.includes(k) ||
    qi.choicesN.some(x => x.includes(k))
  );
}

    // ===== MATHJAX OPTIMIZED RENDER (WAIT STARTUP) =====
let mathRenderTimer = null;
let mathTypesetChain = Promise.resolve(); // kh√≥a h√†ng ƒë·ª£i typeset

function toMathTargets(target) {
  if (!target) return [];
  return Array.isArray(target) ? target.filter(Boolean) : [target];
}

function whenMathJaxReady() {
  if (!window.MathJax) return Promise.resolve();
  if (MathJax.startup && MathJax.startup.promise) return MathJax.startup.promise;
  return Promise.resolve();
}

function renderMath(target) {
  if (!window.MathJax) return;
  const els = toMathTargets(target);
  if (!els.length) return;

  mathTypesetChain = mathTypesetChain
    .then(() => whenMathJaxReady())
    .then(() => MathJax.typesetPromise(els))
    .catch(() => {});
}

function renderMathDebounced(target, delay = 50) {
  if (!window.MathJax) return;
  const els = toMathTargets(target);
  if (!els.length) return;

  clearTimeout(mathRenderTimer);
  mathRenderTimer = setTimeout(() => {
    // serialize ƒë·ªÉ kh√¥ng typeset ch·ªìng l√™n nhau
    mathTypesetChain = mathTypesetChain
      .then(() => whenMathJaxReady())
      .then(() => MathJax.typesetPromise(els))
      .catch(() => {});
  }, delay);
}
$('#btnAIExplain').onclick = async () => {
  const btn = $('#btnAIExplain');
  if (!quiz) return;

  const q = quiz.questions[idx];
  const userAnsIndex = answers[idx]?.value ?? null;

  btn.disabled = true;
  const old = btn.textContent;
  btn.textContent = '‚è≥ ƒêang h·ªèi AI...';

  try {
    const payload = {
      question: q.text,
      choices: q.choices,
      userAnswerIndex: userAnsIndex,
      correctAnswerIndex: q.answer,
      // g·ª≠i th√™m explanation g·ªëc n·∫øu c√≥ (ƒë·ªÉ AI b·ªï sung s√¢u h∆°n)
      teacherExplanation: q.explanation || ''
    };

    const res = await fetch('/api/explain', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
  const t = await res.text(); // ƒë·ªçc body tr·∫£ v·ªÅ
  throw new Error(`API l·ªói: ${res.status}\n${t}`);
}


    const data = await res.json();

    // hi·ªán v√†o √¥ explain (cho ph√©p c√≥ LaTeX)
    $('#explain').innerHTML =
      `<b>AI gi·∫£i th√≠ch:</b><br>${data.explanation || 'Kh√¥ng c√≥ ph·∫£n h·ªìi.'}`;

    // render MathJax cho ph·∫ßn AI v·ª´a tr·∫£ v·ªÅ
    renderMathDebounced($('#explain'), 50);

  } catch (e) {
    $('#explain').textContent = '‚ùå L·ªói khi g·ªçi AI: ' + (e?.message || e);
  } finally {
    btn.disabled = false;
    btn.textContent = old;
  }
};

    let allQuizzes = [], quiz = null, idx = 0, answers = [], timerId = null, wrongStreak = 0;
    let questionFilter = 'all'; // all | bookmark | wrong

    const STORAGE_KEY = "shimechamhoc_progress_v1";
    
    let currentTimeLeft = 0;


    function handleData(data) {
      allQuizzes = Array.isArray(data) ? data : [data];
      buildSearchIndex(allQuizzes);
      if (allQuizzes.length > 1) {
        $('#quizSelectGroup').style.display = 'grid';
        $('#quizSelect').innerHTML = allQuizzes.map((q, i) => `<option value="${i}">${q.title || 'ƒê·ªÅ '+(i+1)}</option>`).join('');
      }
      setupQuiz(0);
    }
    function setupQuiz(index) {
      currentQuizIndex = Number(index) || 0;
  quiz = (window.structuredClone
    ? structuredClone(allQuizzes[index])
    : JSON.parse(JSON.stringify(allQuizzes[index]))
  );
  $('#timeLimit').value = Math.round((quiz.timeLimit||0)/60);
  $('#statusMessage').innerHTML = `ƒê√£ n·∫°p: <b>${quiz.title}</b>. B·∫•m B·∫Øt ƒë·∫ßu ngay!`;
}


    $('#quizSelect').onchange = (e) => setupQuiz(e.target.value);

    window.addEventListener('DOMContentLoaded', () => {
  fetch('data.json')
    .then(r => r.json())
    .then(data => {
      handleData(data);

      const saved = loadProgress();
      if (saved && confirm("üîÑ Ph√°t hi·ªán b√†i l√†m ch∆∞a ho√†n th√†nh. Ti·∫øp t·ª•c kh√¥ng?")) {
        quiz = saved.quiz;
        idx = saved.idx;
        answers = saved.answers;
        if (!Array.isArray(answers) || answers.length !== quiz.questions.length) {
  answers = quiz.questions.map(() => ({ value: null }));
}

        currentTimeLeft = saved.timeLeft;

        $('#instant').checked = saved.settings.instant;
        $('#autoNext').checked = saved.settings.autoNext;
        $('#shuffle').checked = saved.settings.shuffle;

        $('#screenIntro').style.display='none';
        $('#screenQuiz').style.display='block';
        mapBuilt = false;
        qCells = [];
        currentCellIndex = -1;
        buildQuestionMapOnce();
        renderQuestion();

        if (currentTimeLeft > 0) {
          if (timerId) clearInterval(timerId);

          timerId = setInterval(() => {
            currentTimeLeft--;
            saveProgress();

            let m = Math.floor(currentTimeLeft / 60);
            let s = (currentTimeLeft % 60).toString().padStart(2,'0');
            $('#timer').textContent = `${m}:${s}`;

            if(currentTimeLeft <= 0) {
              clearInterval(timerId);
              $('#btnSubmit').click();
            }
          }, 1000);
        } else {
          $('#timer').textContent = '‚àû';
        }
      } else {
        localStorage.removeItem(STORAGE_KEY);
      }
    })
    .catch(() => $('#statusMessage').textContent = "H√£y n·∫°p file JSON.");
});

    $('#fileInput').onchange = (e) => {
      const r = new FileReader();
      r.onload = () => { try { handleData(JSON.parse(r.result)); } catch(err) { alert('File kh√¥ng h·ª£p l·ªá!'); } };
      r.readAsText(e.target.files[0]);
    };
    function saveProgress() {
  if (!quiz || !answers.length) return;

  const data = {
    quiz,
    idx,
    answers,
    timeLeft: currentTimeLeft,
    settings: {
      instant: $('#instant').checked,
      autoNext: $('#autoNext').checked,
      shuffle: $('#shuffle').checked
    }
  };

  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function loadProgress() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return null;

  try {
    return JSON.parse(raw);
  } catch {
    localStorage.removeItem(STORAGE_KEY);
    return null;
  }
}
function buildQuestionMapOnce() {
  const grid = $('#questionGrid');
  if (!grid || mapBuilt || !quiz) return;

  grid.innerHTML = '';
  qCells = new Array(quiz.questions.length);

  quiz.questions.forEach((q, i) => {
    const cell = document.createElement('div');
    cell.className = 'qcell';
    cell.textContent = i + 1;
    cell.dataset.i = i;

    cell.onclick = () => {
      idx = i;
      renderQuestion();
      saveProgress();
    };

    grid.appendChild(cell);
    qCells[i] = cell;
  });

  mapBuilt = true;

  // c·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu 1 l·∫ßn
  updateAllCells();
  updateCurrentCell();
  applyQuestionFilter(); // n·∫øu b·∫°n ƒëang ·ªü filter n√†o ƒë√≥
}

function updateCell(i) {
  const cell = qCells[i];
  if (!cell) return;

  const q = quiz.questions[i];
  const ans = answers[i]?.value ?? null;

  // reset c√°c class tr·∫°ng th√°i
  cell.classList.remove('done', 'correct', 'wrong', 'bookmark', 'current');

  if (ans !== null) cell.classList.add('done');
  if (q.bookmarked) cell.classList.add('bookmark');

  // ch·ªâ t√¥ ƒë√∫ng/sai khi: instant b·∫≠t OR ƒë√£ n·ªôp b√†i
  const canShowResult = $('#instant').checked || isSubmitted;
  if (canShowResult && ans !== null) {
    if (ans === q.answer) cell.classList.add('correct');
    else cell.classList.add('wrong');
  }
}

function updateAllCells() {
  for (let i = 0; i < qCells.length; i++) updateCell(i);
}

function updateCurrentCell() {
  // b·ªè current c≈©
  if (currentCellIndex >= 0 && qCells[currentCellIndex]) {
    qCells[currentCellIndex].classList.remove('current');
  }
  // set current m·ªõi
  currentCellIndex = idx;
  if (qCells[currentCellIndex]) qCells[currentCellIndex].classList.add('current');
}

// Filter ch·ªâ scan 1 l·∫ßn khi b·∫•m filter, KH√îNG scan m·ªói l·∫ßn click ƒë√°p √°n
function applyQuestionFilter() {
  if (!mapBuilt) return;

  for (let i = 0; i < quiz.questions.length; i++) {
    const q = quiz.questions[i];
    const ans = answers[i]?.value ?? null;

    let show = true;

    if (questionFilter === 'bookmark') {
      show = !!q.bookmarked;
    } else if (questionFilter === 'wrong') {
      const canShowWrong = $('#instant').checked || isSubmitted;
      show = (ans !== null) && canShowWrong && (ans !== q.answer);
    }
    if (show && searchKeywordN) {
  show = questionMatches(currentQuizIndex, i);
}
    qCells[i].style.display = show ? '' : 'none';
  }
}

    function renderQuestion() {
      const q = quiz.questions[idx];
      if (q.bookmarked === undefined) q.bookmarked = false;

      $('#qIndex').textContent = `C√¢u ${idx+1}/${quiz.questions.length}`;
      const qTextEl = $('#qText');
      qTextEl.innerHTML = q.text;
      


      const box = $('#qChoices'); box.innerHTML = ''; $('#explain').textContent = '';
      
      q.choices.forEach((c, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'choice';
        if (answers[idx].value === i) wrap.classList.add('active');
        
        if (answers[idx].value !== null && $('#instant').checked) {
            if (i === q.answer) wrap.classList.add('correct');
            else if (i === answers[idx].value) wrap.classList.add('wrong');
        }

        wrap.innerHTML = `
        <input type="radio" name="opt" style="margin-right:10px" ${answers[idx].value === i ? 'checked' : ''}>
        <label style="cursor:pointer">${c}</label>
        `;


        
        wrap.onclick = () => {
        answers[idx].value = i;
        if (mapBuilt) updateCell(idx);
        renderQuestion();
        saveProgress();


          if($('#instant').checked) {
            const ok = (i === q.answer);
            if(!ok) { wrongStreak++; if(wrongStreak >= 3) $('#sheepPopup').style.display='flex'; } 
            else { wrongStreak = 0; }
            if(q.explanation) $('#explain').textContent = "Gi·∫£i th√≠ch: " + q.explanation;
            if ($('#autoNext').checked && ok && idx < quiz.questions.length - 1) {
  setTimeout(() => {
    idx++;
    renderQuestion();
    saveProgress();
  }, 800);
}


          }
        };
        box.appendChild(wrap);
       });
      renderMathDebounced([qTextEl, box]);



      
      $('#btnPrev').disabled = (idx === 0);
      $('#btnNext').style.visibility = (idx === quiz.questions.length - 1) ? 'hidden' : 'visible';
      buildQuestionMapOnce();     // build l∆∞·ªõi 1 l·∫ßn duy nh·∫•t
      updateCell(idx);            // c·∫≠p nh·∫≠t √¥ c·ªßa c√¢u hi·ªán t·∫°i (done/correct/wrong/bookmark)
      updateCurrentCell();        // t√¥ vi·ªÅn current
      applyQuestionFilter();      // n·∫øu ƒëang b·∫≠t filter

      // ===== BOOKMARK UI =====
const bm = $('#bookmarkBtn');
bm.classList.toggle('active', q.bookmarked);
bm.textContent = q.bookmarked ? '‚≠ê' : '‚òÜ';

bm.onclick = () => {
  q.bookmarked = !q.bookmarked;
  bm.classList.toggle('active', q.bookmarked);
  bm.textContent = q.bookmarked ? '‚≠ê' : '‚òÜ';
  saveProgress();
  if (mapBuilt) {
  updateCell(idx);
  applyQuestionFilter();
}
};

    }
    $('#btnNext').onclick = () => {
  if(idx < quiz.questions.length - 1) {
    idx++;
    renderQuestion();
    saveProgress();
  }
};

$('#btnPrev').onclick = () => {
  if(idx > 0) {
    idx--;
    renderQuestion();
    saveProgress();
  }
};


    $('#btnStart').onclick = () => {
  if(!quiz) return;
  if($('#shuffle').checked) quiz.questions.sort(() => Math.random() - 0.5);
  answers = quiz.questions.map(() => ({value: null}));
  idx = 0;

  mapBuilt = false;
  qCells = [];
  currentCellIndex = -1;

  $('#screenIntro').style.display='none';
  $('#screenQuiz').style.display='block';

  buildQuestionMapOnce();
  renderQuestion();
  startTimer();
};

    function launchFireworks() {
  const canvas = document.getElementById("fireworks");
  const ctx = canvas.getContext("2d");

  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let particles = [];

  function boom(x) {
    for (let i = 0; i < 80; i++) {
      particles.push({
        x,
        y: canvas.height * 0.5,
        vx: Math.cos(Math.random() * Math.PI * 2) * (3 + Math.random() * 4),
        vy: Math.sin(Math.random() * Math.PI * 2) * (3 + Math.random() * 4),
        life: 60,
        color: `hsl(${Math.random() * 360},100%,60%)`
      });
    }
  }

  boom(canvas.width * 0.2);
  boom(canvas.width * 0.8);

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach((p, i) => {
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.05;
      p.life--;

      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
      ctx.fill();

      if (p.life <= 0) particles.splice(i, 1);
    });

    if (particles.length) requestAnimationFrame(animate);
  }

  animate();

  const text = document.getElementById("congratsText");
  text.classList.add("show");
  setTimeout(() => text.classList.remove("show"), 4000);
}


    $('#btnSubmit').onclick = () => {
       if(!confirm("B·∫°n mu·ªën n·ªôp b√†i?")) return;
      isSubmitted = true;
      if (mapBuilt) {
      updateAllCells();
      applyQuestionFilter();
      }
      localStorage.removeItem(STORAGE_KEY);
      clearInterval(timerId);
      
      let totalCorrect = 0;
      quiz.questions.forEach((q, i) => {
          if (answers[i].value !== null && answers[i].value === q.answer) {
              totalCorrect++;
          }
      });

      const total = quiz.questions.length;
      const percent = Math.round((totalCorrect / total) * 100);
      
      $('#scoreLine').textContent = `K·∫øt qu·∫£: ${totalCorrect}/${total} c√¢u ƒë√∫ng (${percent}%)`;
      $('#scoreBar').style.width = percent + '%';
      $('#screenQuiz').style.display='none'; 
      $('#screenResult').style.display='block';
      $('#resultOverlay').classList.add('show');
      $('#congratsText').classList.add('show');
      setTimeout(() => {
      $('#resultOverlay').classList.remove('show');
      $('#congratsText').classList.remove('show');
}, 2500);

      
      generateReview();
      launchFireworks();

    };

    function generateReview() {
  const area = $('#reviewArea');
  area.innerHTML = '<h3 style="margin-top:30px">Chi ti·∫øt b√†i l√†m:</h3>';

  quiz.questions.forEach((q, i) => {
    const userAns = answers[i].value;
    const isCorrect = (userAns === q.answer);

    const card = document.createElement('div');
    card.className = 'card pad';
    card.style.marginBottom = '15px';
    card.style.borderLeft = `5px solid ${isCorrect ? 'var(--ok)' : 'var(--bad)'}`;

    card.innerHTML = `
      <div style="font-weight:800; margin-bottom:5px">C√¢u ${i+1}: ${q.text}</div>
      <div style="color:${isCorrect ? 'var(--ok)' : 'var(--bad)'}">
        <div><b>B·∫°n ch·ªçn:</b> ${userAns !== null ? q.choices[userAns] : 'Ch∆∞a tr·∫£ l·ªùi'}</div>
        <div><b>ƒê√°p √°n ƒë√∫ng:</b> ${q.choices[q.answer]}</div>
      </div>
      ${q.explanation ? `<div class="muted" style="margin-top:5px; font-style:italic">Gi·∫£i th√≠ch: ${q.explanation}</div>` : ''}
    `;

    area.appendChild(card);
  });

  // Render MathJax 1 l·∫ßn cho c·∫£ khu review (nhanh h∆°n nhi·ªÅu)
  renderMath(area);
}
    function startTimer(){
  if (timerId) clearInterval(timerId);

  currentTimeLeft = Number($('#timeLimit').value) * 60;
  if(currentTimeLeft <= 0) {
    $('#timer').textContent = '‚àû';
    return;
  }
  timerId = setInterval(() => {
    currentTimeLeft--;
    saveProgress();
    let m = Math.floor(currentTimeLeft / 60);
    let s = (currentTimeLeft % 60).toString().padStart(2,'0');
    $('#timer').textContent = `${m}:${s}`;
    if(currentTimeLeft <= 0) {
      clearInterval(timerId);
      $('#btnSubmit').click();
    }
  }, 1000);
}
    // ===== THEME TOGGLE =====
const themeBtn = document.getElementById('toggleTheme');

function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  setTheme(current === 'dark' ? 'light' : 'dark');
}
// Load theme khi m·ªü trang
const savedTheme = localStorage.getItem('theme') || 'dark';
setTheme(savedTheme);
// Click n√∫t
themeBtn.onclick = toggleTheme;
$('#filterAll').onclick = () => {
  questionFilter = 'all';
  applyQuestionFilter();
};
$('#filterBookmark').onclick = () => {
  questionFilter = 'bookmark';
  applyQuestionFilter();
};
$('#filterWrong').onclick = () => {
  questionFilter = 'wrong';
  applyQuestionFilter();
};
$('#searchBox').oninput = (e) => {
  searchKeywordN = strip(e.target.value); // keyword ƒë√£ strip s·∫µn
  applyQuestionFilter();
};

  </script>
  <canvas id="fireworks"></canvas>
<div id="congratsText">üéâ Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i l√†m!</div>
<div id="resultOverlay"></div>
</body>
</html>
