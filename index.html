<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShimeChamhoc ‚Äì Premium Interface</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg: #0b1220; --card: rgba(22, 32, 53, 0.8); --muted: #94a3b8; 
      --text: #f8fafc; --acc: #38bdf8; --ok: #22c55e; --bad: #ef4444; 
      --border: rgba(255, 255, 255, 0.08);
    }
    * { box-sizing: border-box; transition: all 0.2s ease; }
    body {
      margin: 0; font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top right, #1e293b, #0b1220);
      color: var(--text); line-height: 1.6; min-height: 100vh;
    }
    header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(11, 18, 32, 0.7); backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1100px; margin: auto; padding: 16px; }
    .row { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
    }
    .pad { padding: 24px; }
    .muted { color: var(--muted); font-size: 14px; }
    .btn {
      cursor: pointer; border: none; border-radius: 12px; padding: 12px 18px;
      font-weight: 600; background: #1b2a4a; color: #dbe7ff;
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:hover { transform: translateY(-2px); background: #2a3d66; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .btn.secondary { background: #334155; color: #f1f5f9; }
    .btn.ok { background: #14532d; color: #bbf7d0; }
    .btn.warn { background: #7f1d1d; color: #fecaca; }
    .grid { display: grid; gap: 12px; }
    select#quizSelect {
      width: 100%; padding: 12px; border-radius: 12px;
      border: 1px solid var(--border); background: #0d1424; color: var(--text);
    }
    .choice {
      border: 1px solid var(--border); border-radius: 14px; padding: 16px;
      cursor: pointer; background: rgba(255,255,255,0.03); display: flex; align-items: center;
    }
    .choice:hover { border-color: var(--acc); transform: translateX(4px); }
    .choice.active { outline: 2px solid var(--acc); background: rgba(56, 189, 248, 0.1); }
    .choice.correct { outline: 2px solid var(--ok); background: rgba(34, 197, 94, 0.15); }
    .choice.wrong { outline: 2px solid var(--bad); background: rgba(239, 68, 68, 0.15); }
    .pill { display: inline-block; padding: 4px 12px; border-radius: 8px; background: rgba(56, 189, 248, 0.1); color: var(--acc); font-size: 12px; font-weight: 600; }
    .timer { font-family: monospace; font-size: 18px; color: #fbbf24; }
    .progress { height: 10px; background: #111a2d; border-radius: 999px; overflow: hidden; }
    .progress > div { height: 100%; background: linear-gradient(90deg, var(--acc), #4ade80); transition: width 0.4s ease; }
    #sheepPopup {
      position: fixed; inset: 0; display: none; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 9999;
    }
    #sheepPopup .box { background: #1e293b; border: 2px solid var(--acc); padding: 32px; border-radius: 24px; text-align: center; }
    @media (max-width: 960px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;">
      <div style="font-weight:800;font-size:1.2rem; color: var(--acc)">üìò ShimeChamhoc</div>
      <button class="btn secondary" onclick="$('#fileInput').click()">N·∫°p JSON</button>
    </div>
  </header>

  <main class="wrap" style="margin-top:24px">
    <div class="row">
      <aside class="card pad">
        <h3>C√†i ƒë·∫∑t</h3>
        <div class="grid">
          <div class="grid muted" id="quizSelectGroup" style="display:none">
            <label>Ch·ªçn b·ªô ƒë·ªÅ</label>
            <select id="quizSelect"></select>
          </div>
          <div class="grid muted">
            <label>Th·ªùi gian (ph√∫t)</label>
            <input type="number" id="timeLimit" min="0" value="0" style="padding:10px; border-radius:8px; background:#0d1424; color:white; border:1px solid var(--border)"/>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="shuffle" checked /> <label for="shuffle">X√°o tr·ªôn ƒë·ªÅ</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="instant" checked /> <label for="instant">Ch·∫•m t·ª©c th√¨</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="autoNext" /> <label for="autoNext">T·ª± chuy·ªÉn c√¢u</label>
          </div>
          <button class="btn ok" id="btnStart" style="width:100%; margin-top:10px">B·∫Øt ƒë·∫ßu</button>
        </div>
      </aside>

      <section class="card pad" id="panelMain">
        <div id="screenIntro">
          <h2 style="margin-top:0">S·∫µn s√†ng ch∆∞a?</h2>
          <p class="muted" id="statusMessage">ƒêang ch·ªù d·ªØ li·ªáu...</p>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
        </div>

        <div id="screenQuiz" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <span class="pill" id="qIndex"></span>
            <div class="timer pill" id="timer">--:--</div>
          </div>
          <div id="qText" style="font-size:20px;font-weight:700;margin-bottom:24px;"></div>
          <div id="qChoices" class="grid"></div>
          <div style="display:flex;justify-content:space-between;margin-top:30px; border-top: 1px solid var(--border); padding-top:20px">
            <button class="btn secondary" id="btnPrev">‚Üê Tr∆∞·ªõc</button>
            <div style="display:flex; gap:10px">
              <button class="btn ok" id="btnNext">Ti·∫øp ‚Üí</button>
              <button class="btn warn" id="btnSubmit">N·ªôp b√†i</button>
            </div>
          </div>
          <div id="explain" class="muted" style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px"></div>
        </div>

        <div id="screenResult" style="display:none">
          <h2 style="color: var(--ok)">Ho√†n th√†nh!</h2>
          <p id="scoreLine" style="font-size: 1.5rem; font-weight: 800;"></p>
          <div class="progress" style="margin:20px 0"><div id="scoreBar"></div></div>
          <button class="btn ok" onclick="location.reload()">L√†m ƒë·ªÅ kh√°c</button>
        </div>
      </section>
    </div>
  </main>

  <div id="sheepPopup">
    <div class="box">
      <img src="https://png.pngtree.com/png-vector/20240801/ourlarge/pngtree-sheep-natural-with-a-kawaii-face-cute-cartoon-on-transperant-background-png-image_13322177.png" style="width:100px; margin-bottom:15px">
      <div style="font-weight:800">C·ªë g·∫Øng l√™nnn! üêë</div>
      <p class="muted">Sai 3 c√¢u r·ªìi ƒë√≥, b√¨nh tƒ©nh nh√©!</p>
      <button class="btn ok" onclick="$('#sheepPopup').style.display='none'; wrongStreak=0;">Ti·∫øp t·ª•c</button>
    </div>
  </div>

  <script>
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const strip = (s)=> (s??'').toString().trim().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');

    let allQuizzes = [], quiz = null, idx = 0, answers = [], timerId = null, wrongStreak = 0;

    function handleData(data) {
      allQuizzes = Array.isArray(data) ? data : [data];
      if (allQuizzes.length > 1) {
        $('#quizSelectGroup').style.display = 'grid';
        $('#quizSelect').innerHTML = allQuizzes.map((q, i) => `<option value="${i}">${q.title || 'ƒê·ªÅ '+(i+1)}</option>`).join('');
      }
      setupQuiz(0);
    }

    function setupQuiz(index) {
      quiz = JSON.parse(JSON.stringify(allQuizzes[index]));
      $('#timeLimit').value = Math.round((quiz.timeLimit||0)/60);
      $('#statusMessage').innerHTML = `ƒê√£ n·∫°p: <b>${quiz.title}</b>. B·∫•m B·∫Øt ƒë·∫ßu ngay!`;
    }

    $('#quizSelect').onchange = (e) => setupQuiz(e.target.value);

    window.addEventListener('DOMContentLoaded', () => {
      fetch('data.json').then(r => r.json()).then(handleData).catch(()=> $('#statusMessage').textContent = "H√£y n·∫°p file JSON.");
    });

    $('#fileInput').onchange = (e) => {
      const r = new FileReader();
      r.onload = () => { try { handleData(JSON.parse(r.result)); } catch(err) { alert('File kh√¥ng h·ª£p l·ªá!'); } };
      r.readAsText(e.target.files[0]);
    };

    function renderQuestion() {
      const q = quiz.questions[idx];
      $('#qIndex').textContent = `C√¢u ${idx+1}/${quiz.questions.length}`;
      $('#qText').textContent = q.text;
      const box = $('#qChoices'); box.innerHTML = ''; $('#explain').textContent = '';
      
      q.choices.forEach((c, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'choice';
        if (answers[idx].value === i) wrap.classList.add('active');
        
        // Hi·ªán m√†u ƒë√∫ng/sai n·∫øu ƒë√£ click v√† ƒëang ·ªü ch·∫ø ƒë·ªô ch·∫•m t·ª©c th√¨
        if (answers[idx].value !== null && $('#instant').checked) {
            if (i === q.answer) wrap.classList.add('correct');
            else if (i === answers[idx].value) wrap.classList.add('wrong');
        }

        wrap.innerHTML = `<input type="radio" name="opt" style="margin-right:10px" ${answers[idx].value === i ? 'checked' : ''}> <label style="cursor:pointer">${c}</label>`;
        
        wrap.onclick = () => {
          // L∆∞u ƒë√°p √°n duy nh·∫•t v√†o m·∫£ng answers cho c√¢u n√†y
          answers[idx].value = i;
          
          // V·∫Ω l·∫°i c√¢u h·ªèi ƒë·ªÉ c·∫≠p nh·∫≠t UI ƒë·ªìng b·ªô
          renderQuestion();

          if($('#instant').checked) {
            const isCorrect = (i === q.answer);
            if(!isCorrect) { 
                wrongStreak++; 
                if(wrongStreak >= 3) $('#sheepPopup').style.display='flex'; 
            } else { 
                wrongStreak = 0; 
            }
            if(q.explanation) $('#explain').textContent = "Gi·∫£i th√≠ch: " + q.explanation;
            
            // T·ª± ƒë·ªông chuy·ªÉn c√¢u n·∫øu ƒë√∫ng
            if($('#autoNext').checked && isCorrect && idx < quiz.questions.length - 1) {
               setTimeout(() => { if(idx < quiz.questions.length - 1) { idx++; renderQuestion(); } }, 800);
            }
          }
        };
        box.appendChild(wrap);
      });
      
      $('#btnPrev').disabled = (idx === 0);
      // N√∫t Ti·∫øp theo ch·ªâ ·∫©n ·ªü c√¢u cu·ªëi c√πng
      $('#btnNext').style.visibility = (idx === quiz.questions.length - 1) ? 'hidden' : 'visible';
    }

    $('#btnNext').onclick = () => { if(idx < quiz.questions.length - 1) { idx++; renderQuestion(); } };
    $('#btnPrev').onclick = () => { if(idx > 0) { idx--; renderQuestion(); } };

    $('#btnStart').onclick = () => {
      if(!quiz) return;
      // Tr·ªôn ƒë·ªÅ n·∫øu c√≥ check
      if($('#shuffle').checked) quiz.questions.sort(() => Math.random() - 0.5);
      // Reset m·∫£ng ƒë√°p √°n: m·ªói c√¢u ch·ªâ nh·∫≠n 1 gi√° tr·ªã duy nh·∫•t
      answers = quiz.questions.map(() => ({value: null}));
      idx = 0; 
      $('#screenIntro').style.display='none'; 
      $('#screenQuiz').style.display='block';
      renderQuestion(); startTimer();
    };

    $('#btnSubmit').onclick = () => {
      if(!confirm("B·∫°n mu·ªën n·ªôp b√†i?")) return;
      clearInterval(timerId);
      
      // LOGIC T√çNH ƒêI·ªÇM CHU·∫®N: Ch·ªâ ƒë·∫øm m·ªói c√¢u h·ªèi 1 l·∫ßn
      let totalCorrect = 0;
      quiz.questions.forEach((q, i) => {
          if (answers[i].value !== null && answers[i].value === q.answer) {
              totalCorrect++;
          }
      });

      const total = quiz.questions.length;
      const percent = Math.round((totalCorrect / total) * 100);
      
      $('#scoreLine').textContent = `K·∫øt qu·∫£: ${totalCorrect}/${total} c√¢u ƒë√∫ng (${percent}%)`;
      $('#scoreBar').style.width = percent + '%';
      $('#screenQuiz').style.display='none'; 
      $('#screenResult').style.display='block';
    };

    function startTimer(){
      let totalSec = Number($('#timeLimit').value) * 60;
      if(totalSec <= 0) { $('#timer').textContent='‚àû'; return; }
      timerId = setInterval(() => {
        totalSec--;
        let m = Math.floor(totalSec/60);
        let s = (totalSec%60).toString().padStart(2,'0');
        $('#timer').textContent = `${m}:${s}`;
        if(totalSec <= 0) { clearInterval(timerId); $('#btnSubmit').click(); }
      }, 1000);
    }
  </script>
</body>
</html>